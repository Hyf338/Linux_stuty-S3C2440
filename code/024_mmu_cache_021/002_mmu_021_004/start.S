
.text
.global _start

_start:
	b reset          /* vector 0 : reset */
	ldr pc, und_addr /* vector 4 : und */
	ldr pc, swi_addr /* vector 8 : swi */
	b halt			 /* vector 0x0c : prefetch aboot */
	b halt			 /* vector 0x10 : data abort */
	b halt			 /* vector 0x14 : reserved */
	ldr pc, irq_addr /* vector 0x18 : irq */
	b halt			 /* vector 0x1c : fiq */

und_addr:
	.word do_und

swi_addr:
	.word do_swi

irq_addr:
	.word do_irq

do_und:
	/*æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰:
	 * 1. lr_undä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹ä¸­çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	 * 2. SPSR_undä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	 * 3. CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä¸º11011, è¿›å…¥åˆ°undæ¨¡å¼
	 * 4. è·³åˆ°0x4çš„åœ°æ–¹æ‰§è¡Œç¨‹åº
	 */

	/* sp_undæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®ä»– */
	ldr sp, =0x34000000

	/* åœ¨undå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12,æ‰€ä»¥å…ˆä¿å­˜ */
	/* lråœ¨å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦è¿”å› */
	stmdb sp!, {r0-r12, lr}  
	
	/* ä¿å­˜ç°åœº */
	/* å¤„ç†undå¼‚å¸¸ */
	mrs r0, cpsr
	ldr r1, =und_string
	bl printException
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^  /* ^ä¼šæŠŠspsrçš„å€¼æ¢å¤åˆ°cpsré‡Œ */
	
und_string:
	.string "undefined instruction exception"

.align 4

do_swi:
	/*æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰:
	 * 1. lr_svcä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹ä¸­çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	 * 2. SPSR_svcä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	 * 3. CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä¸º10011, è¿›å…¥åˆ°svcæ¨¡å¼
	 * 4. è·³åˆ°0x08çš„åœ°æ–¹æ‰§è¡Œç¨‹åº
	 */

	/* sp_svcæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®ä»– */
	ldr sp, =0x33e00000

	/* ±£´æÏÖ³¡ */
	/* åœ¨uswiå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12,æ‰€ä»¥å…ˆä¿å­˜ */
	/* lråœ¨å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦è¿”å› */
	stmdb sp!, {r0-r12, lr}  

	mov r4, lr
	
	/* å¤„ç†swiå¼‚å¸¸ */
	mrs r0, cpsr
	ldr r1, =swi_string
	bl printException

	sub r0, r4, #4
	bl printSWIVal
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^  /* ^ä¼šæŠŠspsrçš„å€¼æ¢å¤åˆ°cpsré‡Œ */
	
swi_string:
	.string "swi exception"

.align 4

do_irq:
		/*æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰:
	 * 1. lr_irqä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹ä¸­çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	 * 2. SPSR_irqä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	 * 3. CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä¸º10010, è¿›å…¥åˆ°irqæ¨¡å¼
	 * 4. è·³åˆ°0x18çš„åœ°æ–¹æ‰§è¡Œç¨‹åº
	 */

	/* sp_irqæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®ä»– */
	ldr sp, =0x33d00000

	/* ±£´æÏÖ³¡ */
	/* åœ¨irqå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12,æ‰€ä»¥å…ˆä¿å­˜ */
	/* lråœ¨å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦è¿”å› */
	sub lr, lr, #4
	stmdb sp!, {r0-r12, lr}  
	
	/* å¤„ç†irqå¼‚å¸¸ */
	bl handle_irq_c
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^  /* ^ä¼šæŠŠspsrçš„å€¼æ¢å¤åˆ°cpsré‡Œ */


reset:
	/* å…³é—­çœ‹é—¨ç‹— */
	ldr r0, =0x53000000
	ldr r1, =0
	str r1, [r0]

	/* è®¾ç½®MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */
	/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */
	ldr r0, =0x4C000000
	ldr r1, =0xFFFFFFFF
	str r1, [r0]

	/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */
	ldr r0, =0x4C000014
	ldr r1, =0x5
	str r1, [r0]

	/* è®¾ç½®CPUå·¥ä½œäºå¼‚æ­¥æ¨¡å¼ */
	mrc p15,0,r0,c1,c0,0
	orr r0,r0,#0xc0000000   //R1_nF:OR:R1_iA
	mcr p15,0,r0,c1,c0,0

	/* è®¾ç½®MPLLCON(0x4C000004) = (92<<12)|(1<<4)|(1<<0) 
	 *  m = MDIV+8 = 92+8=100
	 *  p = PDIV+2 = 1+2 = 3
	 *  s = SDIV = 1
	 *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M
	 */
	ldr r0, =0x4C000004
	ldr r1, =(92<<12)|(1<<4)|(1<<0)
	str r1, [r0]

	/* ä¸€æ—¦è®¾ç½®PLL,å°±ä¼šé”å®šlock timeç›´åˆ°PLLè¾“å‡ºç¨³å®š
	 * ç„¶åCPUå·¥ä½œäºæ–°çš„é¢‘ç‡FCLK
	 */

	bl enable_icache

	/* è®¾ç½®å†…å­˜: sp æ ˆ  */
	/* åˆ†è¾¨æ˜¯nor/nandå¯åŠ¨
	 * å†™0åˆ°0åœ°å€ï¼Œå†è¯»å‡ºæ¥
	 * å¦‚æœå¾—åˆ°0ï¼Œè¡¨ç¤º0åœ°å€ä¸Šçš„å†…å®¹è¢«ä¿®æ”¹äº†ï¼Œä»–å¯¹åº”ramï¼Œè¿™å°±æ˜¯nandå¯åŠ¨
	 * å¦åˆ™å°±æ˜¯norå¯åŠ¨
	 */
	mov r1, #0
	ldr r0, [r1] /* è¯»å‡ºåŸæ¥çš„å€¼å¤‡ä»½ */
	str r1, [r1] /* 0->[0] */ 
	ldr r2, [r1] /* r2=[0] */
	cmp r1, r2   /* r1==r2? å¦‚æœç›¸ç­‰è¡¨ç¤ºæ˜¯NANDå¯åŠ¨ */
	ldr sp, =0x40000000+4096 /* å…ˆå‡è®¾æ˜¯norå¯åŠ¨ */
	moveq sp, #4096  /* nandå¯åŠ¨ */
	streq r0, [r1]   /* æ¢å¤åŸæ¥çš„å€¼ */

	bl sdram_init
	//bl sdram_init2	 /* ç”¨åˆ°æœ‰åˆå§‹å€¼çš„æ•°ç»„ï¼Œä¸æ˜¯ä½ç½®æ— å…³ç  */
	
	/* åˆ›å»ºé¡µè¡¨ */
	bl create_page_table

	/* å¯åŠ¨MMU */
	bl mmu_enable


	/* é‡å®šä¹‰text, rodata, dataæ®µæ•´ä¸ªç¨‹åº */
	bl copy2sdram

	/* æ¸…é™¤BSSæ®µ */
	bl clean_bss

	/* å¤ä½ä¹‹åï¼Œcpuå¤„ç†svcæ¨¡å¼
	 * ç°åœ¨ï¼Œåˆ‡æ¢åˆ°usræ¨¡å¼
	 */
	mrs r0, cpsr         /* è¯»å‡ºcpsr */
	bic r0, r0, #0xf     /* ä¿®æ”¹M4-M0ä¸º0b10000, è¿›å…¥usræ¨¡å¼ */
	bic r0, r0, #(1<<7)  /* æ¸…é™¤Iä½, ä½¿èƒ½ä¸­æ–­ */
	msr cpsr, r0

	/* è®¾ç½® sp_usr */
	ldr sp, =0x33f00000

	ldr pc, =sdram
sdram:
	bl uart0_init

	bl print1
	/* æ•…æ„åŠ å…¥ä¸€æ¡æœªå®šä¹‰æŒ‡ä»¤ */
und_code:
	.word 0xdeadc0de  /* æœªå®šä¹‰æŒ‡ä»¤ */
	bl print2

	swi 0x123  /* æ‰§è¡Œæ­¤å‘½ä»¤, è§¦å‘SWIå¼‚å¸¸, è¿›å…¥0x8Ö´æ‰§è¡Œ */

	//bl main  /* Ê¹ä½¿ç”¨BLå‘½ä»¤ç›¸å¯¹è·³è½¬, ç¨‹åºä¾ç„¶åœ¨NOR/sramæ‰§è¡Œ */
	ldr lr, =halt
	ldr pc, =main  /* ç»å¯¹è·³è½¬, è·³åˆ°SDRAM */

halt:
	b halt

enable_icache:
	/* è®¾ç½®åå¤„ç†å™¨ä½¿èƒ½icache */
	mrc p15, 0, r0, c1, c0, 0
	orr r0,r0,#(1<<12)  /* r0 = r0 or (1<<12) */
	mcr p15, 0, r0, c1, c0, 0
	mov pc,lr

mmu_enable:
	/* æŠŠé¡µè¡¨åŸºå€å‘Šè¯‰cp15 */
	ldr r0, =0x32000000
	mcr p15, 0, r0, c2, c0, 0

	/* è®¾ç½®åŸŸä¸º0xffffffffï¼Œä¸è¿›è¡Œæƒé™æ£€æŸ¥ */
	ldr r0,=0xffffffff
	mcr p15, 0, r0, c3, c0, 0

	/* ä½¿èƒ½icacheï¼Œdcacheï¼Œmmu */
	mrc p15, 0, r0, c1, c0, 0
	orr r0,r0,#(1<<12)  /* enable icache */
	orr r0,r0,#(1<<2)	/* enable decache */
	orr r0,r0,#(1<<0)	/* enable mmu */
	mcr p15, 0, r0, c1, c0, 0
	
	mov pc,lr
	


